name: Deploy to EC2
on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
    
    - name: Get Project Version
      id: get_version
      run: |
        VERSION=$(./gradlew properties --no-daemon --console=plain | grep "^version:" | awk '{print $2}')
        echo "project_version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Build and Test Project
      run: |
        chmod +x gradlew
        ./gradlew build test
    
    - name: Upload JAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: eurekaservice-${{ steps.get_version.outputs.project_version }}-jar
        path: build/libs/*.jar

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Get Project Version
      id: get_version
      run: |
        VERSION=$(./gradlew properties --no-daemon --console=plain | grep "^version:" | awk '{print $2}')
        echo "project_version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: eurekaservice-${{ steps.get_version.outputs.project_version }}-jar
        path: ./

    - name: Deploy JAR to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        source: "./*.jar"
        target: "/opt/tata/eurekaservice/"
    
    - name: Deploy and Run Docker Container
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        script: |
          cd /opt/tata/eurekaservice
          
          # 停止並刪除現有容器
          docker stop eurekaservice || true
          docker rm eurekaservice || true
          
          # 確保 JAR 檔案已正確複製
          ls -l /opt/tata/eurekaservice/*.jar
          
          # 檢查 Dockerfile 是否存在，如果不存在則創建
          if [ ! -f Dockerfile ]; then
            cat > Dockerfile << EOL
			# 使用 OpenJDK 21（Alpine 版）作為基礎映像，體積較小且適合容器化部署
			FROM eclipse-temurin:21-jre-alpine

			# 設定工作目錄為 /app
			WORKDIR /app

			# 複製編譯後的 JAR 檔案到容器內
			COPY eurekaservice.jar /app/

			# 確保 JAR 檔案已成功複製
			RUN ls -la /app/

			# 設定 Spring Boot 啟動的環境變數，使用 "develop" 環境
			ENV SPRING_PROFILES_ACTIVE=develop

			# 以 Java 啟動應用程式
			CMD ["java", "-jar", "/app/eurekaservice.jar"]
			EOL
          fi
          
          # 建立 Docker 映像
          docker build --no-cache --progress=plain -t eurekaservice . || exit 1
          
          # 啟動新容器
          docker run -d --name eurekaservice -p 8761:8761 eurekaservice || exit 1
